<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Presensi Team OCC</title>

<style>
body{
  font-family:sans-serif;
  text-align:center;
  padding:20px;
  background:#f0f0f0;
}

#reader{
  width:100%;
  max-width:500px;
  margin:auto;
}

#status{
  margin-top:20px;
  font-weight:bold;
  font-size:18px;
}

#rekap{
  margin-top:20px;
  font-weight:bold;
  font-size:18px;
  white-space:pre-line;
}

.success{color:green;}
.warning{color:orange;}
.error{color:red;}

#tanggal{
  font-size:18px;
  font-weight:bold;
}

#jam{
  font-size:24px;
  margin-bottom:15px;
}

h3{
  margin-top:20px;
}
</style>

</head>
<body>

<h1>Presensi Team OCC</h1>

<div id="tanggal"></div>
<div id="jam"></div>

<h3>Kamera Scan</h3>

<div id="reader"></div>
<div id="status" class="success">Menunggu scan...</div>
<div id="rekap"></div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
const statusEl = document.getElementById("status");
const rekapEl = document.getElementById("rekap");

const FORM_URL =
"https://docs.google.com/forms/d/e/1FAIpQLSfhbHy8EX_RoYo3NGugSuKmEOb06prrdMvULrfpO1XEfGKD6w/formResponse";

let scannedToday = new Set();
let scanner;
let isSubmitting = false;


// ================= CLOCK =================
function updateClock(){

  const now = new Date();

  const tanggal = now.toLocaleDateString("id-ID",{
    weekday:"long",
    day:"numeric",
    month:"long",
    year:"numeric"
  });

  const jam = now.toLocaleTimeString("id-ID");

  document.getElementById("tanggal").innerText = tanggal;
  document.getElementById("jam").innerText = jam + " WIB";
}

setInterval(updateClock,1000);
updateClock();


// ================= KIRIM FORM =================
function kirimForm(entryData){

  const formData = new FormData();

  formData.append("entry.2129652086", entryData.id);
  formData.append("entry.1423031901", entryData.nama);
  formData.append("entry.476602258", entryData.jabatan);

  fetch(FORM_URL,{
    method:"POST",
    mode:"no-cors",
    body:formData
  }).then(()=>{

    const now = new Date();

    statusEl.innerText = "Presensi Berhasil ✔";
    statusEl.className = "success";

    rekapEl.innerText =
`Nama: ${entryData.nama}
Jabatan: ${entryData.jabatan}
Tanggal: ${now.toLocaleDateString("id-ID")}
Jam: ${now.toLocaleTimeString("id-ID")}`;

    // Pause scanner biar gak double scan
    scanner.pause(true);

    setTimeout(()=>{
      statusEl.innerText = "Menunggu scan...";
      scanner.resume();
    },4000);

    isSubmitting = false;
  });
}


// ================= SCAN SUCCESS =================
function onScanSuccess(decodedText){

  if(isSubmitting) return;
  isSubmitting = true;

  const parts = decodedText.split("|");

  if(parts.length !== 3){
    statusEl.innerText = "QR tidak valid ❌";
    statusEl.className = "error";
    isSubmitting = false;
    return;
  }

  const entryData = {
    id:parts[0],
    nama:parts[1],
    jabatan:parts[2]
  };

  const todayKey =
    entryData.id +
    new Date().toLocaleDateString("id-ID");

  if(scannedToday.has(todayKey)){
    statusEl.innerText = "Sudah presensi hari ini ❌";
    statusEl.className = "warning";
    isSubmitting = false;
    return;
  }

  scannedToday.add(todayKey);
  kirimForm(entryData);
}


// ================= START CAMERA =================
window.onload = function(){

  Html5Qrcode.getCameras().then(cameras=>{

    if(!cameras.length){
      statusEl.innerText = "Kamera tidak ditemukan ❌";
      statusEl.className = "error";
      return;
    }

    scanner = new Html5Qrcode("reader");

    scanner.start(
      cameras[0].id,
      { fps:10, qrbox:250 },
      onScanSuccess
    );

  }).catch(()=>{
    statusEl.innerText = "Tidak bisa mengakses kamera ❌";
    statusEl.className = "error";
  });
};
</script>

</body>
</html>
